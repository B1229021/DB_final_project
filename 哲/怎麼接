<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸ç´„ç³»çµ±</title>
    <style>
        /* ...ä½ çš„CSSä¿æŒåŸæ¨£ï¼Œç‚ºæ–¹ä¾¿é–±è®€é€™è£¡çœç•¥... */
    </style>
</head>
<body>
    <div class="container">
        <!-- é é¢æ¨™é¡Œ -->
        <header class="header">
            <h1>ç›¸ç´„ç³»çµ±</h1>
        </header>

        <main>
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <button id="createBtn" class="btn btn-primary">ç™¼èµ·æ´»å‹•</button>
                <select id="categoryFilter" class="select-dropdown">
                    <option value="">æ‰€æœ‰é¡åˆ¥</option>
                    <option value="ç¾é£Ÿ">ç¾é£Ÿ</option>
                    <option value="é‹å‹•">é‹å‹•</option>
                    <option value="å¨›æ¨‚">å¨›æ¨‚</option>
                    <option value="å­¸ç¿’">å­¸ç¿’</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <input type="datetime-local" id="timeFilter" class="time-input">
                <button id="filterBtn" class="btn btn-secondary">ç¯©é¸</button>
                <button id="refreshBtn" class="btn btn-secondary">é‡æ–°è¼‰å…¥</button>
            </div>

            <!-- æ´»å‹•åˆ—è¡¨ -->
            <div id="eventsList" class="events-list">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- ç™¼èµ·æ´»å‹•å½ˆçª— -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç™¼èµ·æ´»å‹•</h2>
                <span class="close" id="closeCreate">&times;</span>
            </div>
            <form id="createForm">
                <div class="form-group">
                    <label>æ´»å‹•æ™‚é–“:</label>
                    <input type="datetime-local" id="eventTime" name="eventTime" required>
                </div>
                <div class="form-group">
                    <label>å‡ºç™¼åœ°é»:</label>
                    <input type="text" id="startLocation" name="startLocation" required>
                </div>
                <div class="form-group">
                    <label>ç›®çš„åœ°:</label>
                    <input type="text" id="destination" name="destination" required>
                </div>
                <div class="form-group">
                    <label>æ´»å‹•é¡åˆ¥:</label>
                    <select id="eventCategory" name="eventCategory" required>
                        <option value="">é¸æ“‡é¡åˆ¥</option>
                        <option value="ç¾é£Ÿ">ç¾é£Ÿ</option>
                        <option value="é‹å‹•">é‹å‹•</option>
                        <option value="å¨›æ¨‚">å¨›æ¨‚</option>
                        <option value="å­¸ç¿’">å­¸ç¿’</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>äººæ•¸ä¸Šé™:</label>
                    <input type="number" id="maxParticipants" name="maxParticipants" min="2" max="20" value="4">
                </div>
                <div class="form-group">
                    <label>å‚™è¨»èªªæ˜:</label>
                    <textarea id="description" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>è¯çµ¡æ–¹å¼:</label>
                    <input type="text" id="contact" name="contact" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ç™¼èµ·æ´»å‹•</button>
                    <button type="button" id="cancelCreate" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ´»å‹•è©³æƒ…å½ˆçª— -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ´»å‹•è©³æƒ…</h2>
                <span class="close" id="closeDetail">&times;</span>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script>
    // ==============================================
    // å‰ç«¯ JS åŠŸèƒ½èªªæ˜èˆ‡è¨»è§£
    // ==============================================
    // 1. æ‰€æœ‰æ´»å‹•è³‡æ–™éƒ½å¾ this.apiBaseUrl æä¾›çš„APIå–å¾—/é€å‡º
    // 2. ä½ åªéœ€ç¶­è­·HTMLå’ŒåŸºæœ¬JSçµæ§‹ï¼Œè³‡æ–™ç›¸é—œfunctionæœªä¾†äº¤ç”±å¾Œç«¯äººå“¡å¯¦ä½œ
    // 3. å¯ç›´æ¥å°‹æ‰¾ä¸‹æ–¹ã€ŒTODOã€è¨»è§£ï¼Œä¿®æ”¹ç‚ºé€£æ¥å¾Œç«¯API
    // ==============================================
    class AppointmentSystem {
        constructor() {
            // TODO: è«‹å¾Œç«¯äººå“¡å°‡æ­¤URLæ”¹ç‚ºå¯¦éš›APIè·¯å¾‘
            this.apiBaseUrl = 'https://your-api-domain.com/api';
            this.events = []; // æ´»å‹•è³‡æ–™
            // TODO: å°‡ currentUserId æ›æˆå¯¦éš›ç™»å…¥ç”¨æˆ¶ID
            this.currentUserId = 1;
            this.init();
        }

        init() {
            this.setupEventListeners();
            this.loadEvents();
        }

        setupEventListeners() {
            document.getElementById('createBtn').addEventListener('click', () => this.showCreateModal());
            document.getElementById('closeCreate').addEventListener('click', () => this.hideCreateModal());
            document.getElementById('cancelCreate').addEventListener('click', () => this.hideCreateModal());
            document.getElementById('createForm').addEventListener('submit', (e) => this.handleCreateSubmit(e));
            document.getElementById('closeDetail').addEventListener('click', () => this.hideDetailModal());
            document.getElementById('filterBtn').addEventListener('click', () => this.filterEvents());
            document.getElementById('refreshBtn').addEventListener('click', () => this.loadEvents());
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // è¼‰å…¥æ´»å‹•è³‡æ–™
        async loadEvents() {
            try {
                this.showLoading();
                // TODO: é€£æ¥å¾Œç«¯APIå–å¾—æ´»å‹•è³‡æ–™ï¼Œæ›¿æ›ä¸‹æ–¹é€™æ®µ
                // const response = await fetch(`${this.apiBaseUrl}/events`);
                // const events = await response.json();
                const events = await this.getMockEvents(); // <-- æ¨¡æ“¬è³‡æ–™ï¼Œé–‹ç™¼æ™‚è«‹ç§»é™¤
                this.events = events;
                this.renderEvents(events);
            } catch (error) {
                this.showNotification('è¼‰å…¥æ´»å‹•å¤±æ•—', 'error');
                this.renderEvents([]);
            }
        }

        // TODO: é€™è£¡æ˜¯æ¨¡æ“¬è³‡æ–™ï¼Œè«‹ç§»é™¤ï¼Œæ”¹ç‚ºAPIè³‡æ–™
        async getMockEvents() {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve([
                        {
                            id: 1,
                            title: 'è¥¿é–€ç”ºç¾é£Ÿä¹‹æ—…',
                            category: 'ç¾é£Ÿ',
                            time: '2025-05-25T19:00',
                            startLocation: 'å°åŒ—è»Šç«™',
                            destination: 'è¥¿é–€ç”º',
                            description: 'ä¸€èµ·å»è¥¿é–€ç”ºåƒç¾é£Ÿï¼',
                            maxParticipants: 4,
                            currentParticipants: 2,
                            participants: [1, 2],
                            creatorId: 2,
                            contact: 'Line: foodlover123',
                            createdAt: '2025-05-22T10:00:00'
                        }
                    ]);
                }, 1000);
            });
        }

        // å»ºç«‹æ–°æ´»å‹•
        async createEvent(eventData) {
            try {
                // TODO: æ”¹ç‚ºå‘¼å«APIæ–°å¢æ´»å‹•
                // const response = await fetch(`${this.apiBaseUrl}/events`, {...})
                // const result = await response.json();
                // æ¨¡æ“¬APIå›æ‡‰
                const result = {
                    success: true,
                    id: Date.now(),
                    message: 'æ´»å‹•ç™¼èµ·æˆåŠŸ'
                };
                if (result.success) {
                    const newEvent = {
                        ...eventData,
                        id: result.id,
                        currentParticipants: 1,
                        participants: [this.currentUserId],
                        creatorId: this.currentUserId,
                        createdAt: new Date().toISOString()
                    };
                    this.events.unshift(newEvent);
                }
                return result;
            } catch (error) {
                throw new Error('ç™¼èµ·æ´»å‹•å¤±æ•—');
            }
        }

        // åŠ å…¥æ´»å‹•
        async joinEvent(eventId) {
            try {
                // TODO: å‘¼å«APIåƒåŠ æ´»å‹•
                // const response = await fetch(`${this.apiBaseUrl}/events/${eventId}/join`, {...});
                // const result = await response.json();
                const event = this.events.find(e => e.id === eventId);
                if (!event) {
                    this.showNotification('æ´»å‹•ä¸å­˜åœ¨', 'error');
                    return;
                }
                if (event.participants.includes(this.currentUserId)) {
                    this.showNotification('æ‚¨å·²ç¶“åƒèˆ‡æ­¤æ´»å‹•', 'error');
                    return;
                }
                if (event.currentParticipants >= event.maxParticipants) {
                    this.showNotification('æ´»å‹•å·²æ»¿', 'error');
                    return;
                }
                event.currentParticipants++;
                event.participants.push(this.currentUserId);
                this.showNotification('æˆåŠŸåŠ å…¥æ´»å‹•ï¼', 'success');
                this.renderEvents(this.events);
            } catch (error) {
                this.showNotification('åŠ å…¥æ´»å‹•å¤±æ•—', 'error');
            }
        }

        // å–æ¶ˆåƒåŠ 
        async leaveEvent(eventId) {
            try {
                // TODO: å‘¼å«APIå–æ¶ˆåƒåŠ 
                // const response = await fetch(`${this.apiBaseUrl}/events/${eventId}/leave`, {...});
                // const result = await response.json();
                const event = this.events.find(e => e.id === eventId);
                if (!event) {
                    this.showNotification('æ´»å‹•ä¸å­˜åœ¨', 'error');
                    return;
                }
                if (event.creatorId === this.currentUserId) {
                    this.showNotification('ç™¼èµ·äººç„¡æ³•å–æ¶ˆåƒèˆ‡ï¼Œè«‹ç›´æ¥å–æ¶ˆæ´»å‹•', 'error');
                    return;
                }
                const idx = event.participants.indexOf(this.currentUserId);
                if (idx === -1) {
                    this.showNotification('æ‚¨æœªåƒèˆ‡æ­¤æ´»å‹•', 'error');
                    return;
                }
                event.participants.splice(idx, 1);
                event.currentParticipants--;
                this.showNotification('å·²å–æ¶ˆåƒèˆ‡', 'success');
                this.renderEvents(this.events);
            } catch (error) {
                this.showNotification('å–æ¶ˆåƒèˆ‡å¤±æ•—', 'error');
            }
        }

        // å–æ¶ˆæ´»å‹•ï¼ˆç™¼èµ·äººï¼‰
        async cancelEvent(eventId) {
            try {
                // TODO: å‘¼å«APIåˆªé™¤æ´»å‹•
                // const response = await fetch(`${this.apiBaseUrl}/events/${eventId}`, {method: 'DELETE'});
                // const result = await response.json();
                const idx = this.events.findIndex(e => e.id === eventId);
                if (idx === -1) {
                    this.showNotification('æ´»å‹•ä¸å­˜åœ¨', 'error');
                    return;
                }
                const event = this.events[idx];
                if (event.creatorId !== this.currentUserId) {
                    this.showNotification('åªæœ‰ç™¼èµ·äººå¯ä»¥å–æ¶ˆæ´»å‹•', 'error');
                    return;
                }
                if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™å€‹æ´»å‹•å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    return;
                }
                this.events.splice(idx, 1);
                this.showNotification('æ´»å‹•å·²å–æ¶ˆ', 'success');
                this.renderEvents(this.events);
            } catch (error) {
                this.showNotification('å–æ¶ˆæ´»å‹•å¤±æ•—', 'error');
            }
        }

        showLoading() {
            document.getElementById('eventsList').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            `;
        }

        // æ´»å‹•å¡ç‰‡æ¸²æŸ“
        renderEvents(events) {
            const eventsList = document.getElementById('eventsList');
            if (events.length === 0) {
                eventsList.innerHTML = `
                    <div class="empty-state">
                        <h3>æš«ç„¡æ´»å‹•</h3>
                        <p>ç›®å‰æ²’æœ‰æ´»å‹•ï¼Œç™¼èµ·ä¸€å€‹æ–°æ´»å‹•å§ï¼</p>
                        <button class="btn btn-primary" onclick="app.showCreateModal()">ç™¼èµ·æ´»å‹•</button>
                    </div>
                `;
                return;
            }
            eventsList.innerHTML = events.map(event => {
                const isFull = event.currentParticipants >= event.maxParticipants;
                const isJoined = event.participants && event.participants.includes(this.currentUserId);
                const isCreator = event.creatorId === this.currentUserId;
                let actionBtn = '';
                if (isCreator) {
                    actionBtn = `<button class="btn btn-danger join-btn" onclick="event.stopPropagation(); app.cancelEvent(${event.id})">å–æ¶ˆæ´»å‹•</button>`;
                } else if (isJoined) {
                    actionBtn = `<button class="btn btn-secondary join-btn" onclick="event.stopPropagation(); app.leaveEvent(${event.id})">å–æ¶ˆåƒèˆ‡</button>`;
                } else if (!isFull) {
                    actionBtn = `<button class="btn btn-primary join-btn" onclick="event.stopPropagation(); app.joinEvent(${event.id})">åŠ å…¥ +1</button>`;
                } else {
                    actionBtn = `<span class="btn btn-secondary join-btn">å·²æ»¿</span>`;
                }
                return `
                    <div class="event-card" onclick="app.showEventDetail(${event.id})">
                        <div class="event-header">
                            <span class="event-category">${event.category}</span>
                            <span class="event-time">${this.formatDateTime(event.time)}</span>
                        </div>
                        <div class="event-details">
                            <div class="event-detail-item">
                                <span class="event-detail-label">æ´»å‹•:</span>
                                <span class="event-detail-value">${event.title || event.destination}</span>
                            </div>
                            <div class="event-detail-item">
                                <span class="event-detail-label">å‡ºç™¼:</span>
                                <span class="event-detail-value">${event.startLocation}</span>
                            </div>
                            <div class="event-detail-item">
                                <span class="event-detail-label">ç›®çš„åœ°:</span>
                                <span class="event-detail-value">${event.destination}</span>
                            </div>
                            ${event.description ? `
                            <div class="event-detail-item">
                                <span class="event-detail-label">èªªæ˜:</span>
                                <span class="event-detail-value">${event.description}</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="event-footer">
                            <div class="participant-count">
                                <span>ğŸ‘¥</span>
                                <span>${event.currentParticipants}/${event.maxParticipants}</span>
                            </div>
                            ${actionBtn}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç™¼èµ·æ´»å‹•è¦–çª—
        showCreateModal() {
            document.getElementById('createModal').style.display = 'block';
        }
        hideCreateModal() {
            document.getElementById('createModal').style.display = 'none';
            document.getElementById('createForm').reset();
        }

        // æ–°å¢æ´»å‹•è¡¨å–®é€å‡º
        async handleCreateSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const eventData = {
                title: formData.get('destination') || document.getElementById('destination').value,
                category: document.getElementById('eventCategory').value,
                time: document.getElementById('eventTime').value,
                startLocation: document.getElementById('startLocation').value,
                destination: document.getElementById('destination').value,
                description: document.getElementById('description').value,
                maxParticipants: parseInt(document.getElementById('maxParticipants').value),
                contact: document.getElementById('contact').value
            };
            try {
                const result = await this.createEvent(eventData);
                if (result.success) {
                    this.showNotification('æ´»å‹•ç™¼èµ·æˆåŠŸï¼', 'success');
                    this.hideCreateModal();
                    this.renderEvents(this.events);
                } else {
                    this.showNotification('ç™¼èµ·æ´»å‹•å¤±æ•—', 'error');
                }
            } catch (error) {
                this.showNotification('ç™¼èµ·æ´»å‹•å¤±æ•—', 'error');
            }
        }

        // æ´»å‹•è©³æƒ…å½ˆçª—
        showEventDetail(eventId) {
            const event = this.events.find(e => e.id === eventId);
            if (!event) return;
            const isFull = event.currentParticipants >= event.maxParticipants;
            const isJoined = event.participants && event.participants.includes(this.currentUserId);
            const isCreator = event.creatorId === this.currentUserId;
            let actionBtn = '';
            if (isCreator) {
                actionBtn = `<button class="btn btn-danger" onclick="app.cancelEvent(${event.id}); app.hideDetailModal();">å–æ¶ˆæ´»å‹•</button>`;
            } else if (isJoined) {
                actionBtn = `<button class="btn btn-secondary" onclick="app.leaveEvent(${event.id}); app.hideDetailModal();">å–æ¶ˆåƒèˆ‡</button>`;
            } else if (!isFull) {
                actionBtn = `<button class="btn btn-primary" onclick="app.joinEvent(${event.id}); app.hideDetailModal();">åŠ å…¥æ´»å‹•</button>`;
            } else {
                actionBtn = `<span class="btn btn-secondary">æ´»å‹•å·²æ»¿</span>`;
            }
            document.getElementById('detailContent').innerHTML = `
                <div style="padding: 1.5rem;">
                    <div class="event-detail-item">
                        <span class="event-detail-label">æ´»å‹•æ™‚é–“:</span>
                        <span class="event-detail-value">${this.formatDateTime(event.time)}</span>
                    </div>
                    <div class="event-detail-item">
                        <span class="event-detail-label">å‡ºç™¼åœ°é»:</span>
                        <span class="event-detail-value">${event.startLocation}</span>
                    </div>
                    <div class="event-detail-item">
                        <span class="event-detail-label">ç›®çš„åœ°:</span>
                        <span class="event-detail-value">${event.destination}</span>
                    </div>
                    <div class="event-detail-item">
                        <span class="event-detail-label">æ´»å‹•é¡åˆ¥:</span>
                        <span class="event-detail-value">${event.category}</span>
                    </div>
                    <div class="event-detail-item">
                        <span class="event-detail-label">äººæ•¸:</span>
                        <span class="event-detail-value">${event.currentParticipants}/${event.maxParticipants}</span>
                    </div>
                    ${event.description ? `
                    <div class="event-detail-item">
                        <span class="event-detail-label">å‚™è¨»èªªæ˜:</span>
                        <span class="event-detail-value">${event.description}</span>
                    </div>
                    ` : ''}
                    <div class="event-detail-item">
                        <span class="event-detail-label">è¯çµ¡æ–¹å¼:</span>
                        <span class="event-detail-value">${event.contact}</span>
                    </div>
                </div>
                <div class="form-actions">
                    ${actionBtn}
                    <button class="btn btn-secondary" onclick="app.hideDetailModal()">é—œé–‰</button>
                </div>
            `;
            document.getElementById('detailModal').style.display = 'block';
        }
        hideDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // ç¯©é¸åŠŸèƒ½ï¼ˆé¡åˆ¥/æ™‚é–“ï¼‰
        filterEvents() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;
            let filteredEvents = this.events;
            if (categoryFilter) {
                filteredEvents = filteredEvents.filter(event => event.category === categoryFilter);
            }
            if (timeFilter) {
                const filterDate = new Date(timeFilter);
                filteredEvents = filteredEvents.filter(event => {
                    const eventDate = new Date(event.time);
                    return eventDate >= filterDate;
                });
            }
            this.renderEvents(filteredEvents);
        }

        // æ™‚é–“æ ¼å¼åŒ–
        formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${month}/${day} ${hours}:${minutes}`;
        }

        // é€šçŸ¥
        showNotification(message, type = 'success') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) existingNotification.remove();
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    }

    // ===============================
    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    // ===============================
    const app = new AppointmentSystem();
    </script>
</body>
</html>
