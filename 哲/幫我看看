<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸ç´„ç³»çµ±</title>
    <style>
        /* ...åŸæœ‰ CSS å…¨éƒ¨ä¿ç•™... */

        /* ========== ç®¡ç†è€…æŒ‰éˆ•æ¨£å¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* è®“é‚Šæ¡†å’Œå…§è·åŒ…å«åœ¨å…ƒç´ ç¸½å¯¬åº¦å…§ */
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            /* è¨­å®šæ¼¸å±¤èƒŒæ™¯è‰² */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; /* ç¢ºä¿é é¢è‡³å°‘ä½”æ»¿æ•´å€‹è¦–çª—é«˜åº¦ */
            color: #333;
        }

        /* ========== ä¸»è¦å®¹å™¨æ¨£å¼ ========== */
        .container {
            max-width: 1200px;
            margin: 0 auto; /* æ°´å¹³ç½®ä¸­ */
            padding: 0 15px;
            min-height: 100vh;
        }

        /* ========== é é¢æ¨™é¡Œå€åŸŸ ========== */
        .header {
            background: rgba(255, 255, 255, 0.95); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            backdrop-filter: blur(10px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
            padding: 1rem;
            border-radius: 15px;
            margin: 1rem 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); /* é™°å½±æ•ˆæœ */
            text-align: center;
        }

        .header h1 {
            color: #764ba2;
            font-size: 1.8rem;
            font-weight: 700;
        }

        /* ========== æ§åˆ¶é¢æ¿æ¨£å¼ ========== */
        .control-panel {
            background: rgba(255, 255, 255, 0.9);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px; /* å…ƒç´ é–“è· */
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
            align-items: center;
        }

        /* ========== æŒ‰éˆ•åŸºç¤æ¨£å¼ ========== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px; /* åœ“è§’æŒ‰éˆ• */
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease; /* å¹³æ»‘éæ¸¡æ•ˆæœ */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* ä¸»è¦æŒ‰éˆ•æ¨£å¼ï¼ˆæ¼¸å±¤è—ç´«è‰²ï¼‰ */
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px); /* æ‡¸åœæ™‚å‘ä¸Šç§»å‹• */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* æ¬¡è¦æŒ‰éˆ•æ¨£å¼ï¼ˆç°è‰²ï¼‰ */
        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }

        /* å±éšªæŒ‰éˆ•æ¨£å¼ï¼ˆç´…è‰²ï¼‰ */
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }

        /* ========== è¡¨å–®æ§åˆ¶é …æ¨£å¼ ========== */
        .select-dropdown, .time-input {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 0.9rem;
            background: white;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        /* ========== æ´»å‹•åˆ—è¡¨ç¶²æ ¼ä½ˆå±€ ========== */
        .events-list {
            display: grid;
            /* éŸ¿æ‡‰å¼ç¶²æ ¼ï¼šæ¯åˆ—æœ€å°‘300pxå¯¬åº¦ï¼Œè‡ªå‹•å¡«æ»¿ */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem; /* ç¶²æ ¼é–“è· */
            margin-bottom: 2rem;
        }

        /* ========== æ´»å‹•å¡ç‰‡æ¨£å¼ ========== */
        .event-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer; /* æ»‘é¼ æŒ‡æ¨™è®Šæˆæ‰‹å‹ */
        }

        /* å¡ç‰‡æ‡¸åœæ•ˆæœ */
        .event-card:hover {
            transform: translateY(-5px); /* å‘ä¸Šæµ®èµ·æ•ˆæœ */
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* æ´»å‹•å¡ç‰‡é ­éƒ¨å€åŸŸ */
        .event-header {
            display: flex;
            justify-content: space-between; /* å…©ç«¯å°é½Š */
            align-items: center;
            margin-bottom: 1rem;
        }

        /* æ´»å‹•é¡åˆ¥æ¨™ç±¤ */
        .event-category {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* æ´»å‹•æ™‚é–“é¡¯ç¤º */
        .event-time {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* ========== æ´»å‹•è©³æƒ…å€åŸŸ ========== */
        .event-details {
            margin-bottom: 1rem;
        }

        /* æ¯å€‹è©³æƒ…é …ç›® */
        .event-detail-item {
            display: flex;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        /* è©³æƒ…æ¨™ç±¤ï¼ˆå¦‚ï¼šæ´»å‹•ã€å‡ºç™¼ç­‰ï¼‰ */
        .event-detail-label {
            font-weight: 600;
            color: #555;
            min-width: 80px; /* å›ºå®šå¯¬åº¦è®“å°é½Šæ›´æ•´é½Š */
        }

        /* è©³æƒ…å€¼ */
        .event-detail-value {
            color: #777;
            flex: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
        }
        .admin-btn {
            position: absolute;
            top: 18px;
            right: 32px;
            z-index: 10;
            background: linear-gradient(45deg, #ff9800, #ff5722);
            color: white;
            border: none;
            border-radius: 18px;
            padding: 10px 22px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn:hover {
            background: linear-gradient(45deg, #ff5722, #ff9800);
        }

        .avatar-list {
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
            align-items: center;
        }
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(100,80,150,0.09);
            cursor: pointer;
            position: relative;
        }
        .avatar.creator::after {
            content: 'ğŸ‘‘';
            position: absolute;
            right: -10px;
            top: -10px;
            font-size: 1rem;
        }
        .avatar:hover {
            outline: 2px solid #764ba2;
        }

        /* è©•åƒ¹å½ˆçª— */
        .user-review-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.35);
        }
        .user-review-content {
            background: #fff;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            margin: 6% auto;
            padding: 1.5rem 1rem 1rem 1rem;
            box-shadow: 0 18px 44px rgba(0,0,0,0.24);
            position: relative;
        }
        .close-user-review {
            position: absolute;
            top: 14px;
            right: 18px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }
        .user-review-header {
            text-align: center;
            margin-bottom: 1.2rem;
        }
        .user-review-header img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 3px solid #764ba2;
        }
        .user-review-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #764ba2;
            margin-top: 0.3rem;
        }
        .user-review-gb {
            margin: 0.4rem 0 1rem 0;
            font-size: 1rem;
        }
        .review-msg-list {
            max-height: 160px;
            overflow-y: auto;
            margin-top: 0.7rem;
        }
        .review-msg-item {
            font-size: 0.97rem;
            padding: 0.3rem 0.2rem;
            border-bottom: 1px solid #eee;
        }
        .review-msg-item:last-child { border-bottom: none; }
        /* æ€§åˆ¥äººæ•¸ä¸‹æ‹‰ */
        .gender-selects {
            display: flex;
            gap: 1rem;
        }
        .gender-selects .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .admin-btn {
            position: absolute;
            top: 18px;
            right: 32px;
            z-index: 100;
            background: linear-gradient(45deg, #ff9800, #ff5722);
            color: white;
            border: none;
            border-radius: 18px;
            padding: 10px 22px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn:hover {
            background: linear-gradient(45deg, #ff5722, #ff9800);
        }
        /* ========== Modal z-index ä¿®æ­£ ========== */
        .modal {
            z-index: 2001 !important;
        }
        .user-review-modal {
            z-index: 2002 !important;
        }
        .modal {
    display: none;
    position: fixed;
    z-index: 2001;
    left: 0; top: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.35);
    justify-content: center;
    align-items: center;
}
.modal.show {
    display: flex;
}
.modal-content {
    background: #fff;
    border-radius: 20px;
    min-width: 340px;
    max-width: 430px;
    width: 96%;
    box-shadow: 0 18px 44px rgba(0,0,0,0.24);
    position: relative;
    padding: 2rem 2rem 1.2rem 2rem;
    animation: modalFadeIn 0.32s;
}
@keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(30px);}
    to { opacity: 1; transform: translateY(0);}
}
.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.2rem;
}
.modal-header h2 {
    color: #6c48c9;
    font-size: 1.28rem;
    margin: 0;
    font-weight: bold;
}
.close {
    font-size: 1.6rem;
    cursor: pointer;
    color: #888;
    font-weight: bold;
    transition: color 0.2s;
}
.close:hover {
    color: #444;
}
.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
}
        /* ...é ­åƒã€æ€§åˆ¥ä¸‹æ‹‰ç­‰ CSS ä¿ç•™... */
    </style>
</head>
<body>
    <div class="container" style="position:relative">
        <!-- ç®¡ç†è€…æŒ‰éˆ• -->
        <button class="admin-btn" id="adminBtn">ç®¡ç†è€…</button>
        <!-- é é¢æ¨™é¡Œ -->
        <header class="header">
            <h1>ç›¸ç´„ç³»çµ±</h1>
        </header>

        <main>
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <button id="createBtn" class="btn btn-primary">ç™¼èµ·æ´»å‹•</button>
                <select id="categoryFilter" class="select-dropdown">
                    <option value="">æ‰€æœ‰é¡åˆ¥</option>
                    <option value="ç¾é£Ÿ">ç¾é£Ÿ</option>
                    <option value="é‹å‹•">é‹å‹•</option>
                    <option value="å¨›æ¨‚">å¨›æ¨‚</option>
                    <option value="å­¸ç¿’">å­¸ç¿’</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <input type="datetime-local" id="timeFilter" class="time-input">
                <button id="filterBtn" class="btn btn-secondary">ç¯©é¸</button>
                <button id="refreshBtn" class="btn btn-secondary">é‡æ–°è¼‰å…¥</button>
            </div>
            <!-- æ´»å‹•åˆ—è¡¨ -->
            <div id="eventsList" class="events-list">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- ç™¼èµ·æ´»å‹•å½ˆçª— -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç™¼èµ·æ´»å‹•</h2>
                <span class="close" id="closeCreate">&times;</span>
            </div>
            <form id="createForm">
                <div class="form-group">
                    <label>æ´»å‹•æ™‚é–“:</label>
                    <input type="datetime-local" id="eventTime" required name="eventTime">
                </div>
                <div class="form-group">
                    <label>å‡ºç™¼åœ°é»:</label>
                    <input type="text" id="startLocation" placeholder="ä¾‹å¦‚ï¼šå°åŒ—è»Šç«™" required name="startLocation">
                </div>
                <div class="form-group">
                    <label>ç›®çš„åœ°:</label>
                    <input type="text" id="destination" placeholder="ä¾‹å¦‚ï¼šæŸæŸé¤å»³" required name="destination">
                </div>
                <div class="form-group">
                    <label>æ´»å‹•é¡åˆ¥:</label>
                    <select id="eventCategory" required name="eventCategory">
                        <option value="">é¸æ“‡é¡åˆ¥</option>
                        <option value="ç¾é£Ÿ">ç¾é£Ÿ</option>
                        <option value="é‹å‹•">é‹å‹•</option>
                        <option value="å¨›æ¨‚">å¨›æ¨‚</option>
                        <option value="å­¸ç¿’">å­¸ç¿’</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <!-- æ€§åˆ¥äººæ•¸è¨­å®š -->
                <div class="gender-selects" style="margin-bottom:1.5rem;">
                    <div class="form-group">
                        <label>ç”·ç”Ÿäººæ•¸ä¸Šé™:</label>
                        <select id="maxMale" required name="maxMale">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å¥³ç”Ÿäººæ•¸ä¸Šé™:</label>
                        <select id="maxFemale" required name="maxFemale">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>äººæ•¸ä¸Šé™(ç¸½):</label>
                    <input type="number" id="maxParticipants" min="2" max="20" value="4" required name="maxParticipants">
                </div>
                <div class="form-group">
                    <label>å‚™è¨»èªªæ˜:</label>
                    <textarea id="description" placeholder="æ´»å‹•è©³ç´°èªªæ˜æˆ–ç‰¹æ®Šè¦æ±‚" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>è¯çµ¡æ–¹å¼:</label>
                    <input type="text" id="contact" placeholder="é›»è©±æˆ–Line ID" required name="contact">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ç™¼èµ·æ´»å‹•</button>
                    <button type="button" id="cancelCreate" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ´»å‹•è©³æƒ…å½ˆçª— -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ´»å‹•è©³æƒ…</h2>
                <span class="close" id="closeDetail">&times;</span>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- ç”¨æˆ¶è©•åƒ¹å½ˆçª— -->
    <div class="user-review-modal" id="userReviewModal">
        <div class="user-review-content" id="userReviewContent">
            <span class="close-user-review" id="closeUserReview">&times;</span>
            <!-- å…§å®¹ç”±jsç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // æ¨¡æ“¬admintable uidï¼ˆå¯æ›¿æ›ç‚ºAPIæŸ¥è©¢ï¼‰
        const adminUidTable = [1, 99, 100];

        // æ¨¡æ“¬æ‰€æœ‰ç”¨æˆ¶è³‡æ–™åº«
        const usersDB = [
            {
                uid: 1, name: 'Jerry', gender: 'male', avatarUrl: 'https://randomuser.me/api/portraits/men/15.jpg',
                review: { good: 8, bad: 1, msgs: ['å¾ˆæº–æ™‚', 'äººå¾ˆå‹å–„'] }
            },
            {
                uid: 2, name: 'Amy', gender: 'female', avatarUrl: 'https://randomuser.me/api/portraits/women/11.jpg',
                review: { good: 5, bad: 0, msgs: ['æºé€šé †æš¢', 'æ´»æ½‘é–‹æœ—'] }
            },
            {
                uid: 3, name: 'Eric', gender: 'male', avatarUrl: 'https://randomuser.me/api/portraits/men/17.jpg',
                review: { good: 2, bad: 2, msgs: ['æœ‰é»é²åˆ°', 'é‚„ç®—OK'] }
            },
            {
                uid: 4, name: 'Mary', gender: 'female', avatarUrl: 'https://randomuser.me/api/portraits/women/19.jpg',
                review: { good: 1, bad: 0, msgs: ['å¾ˆæœ‰ç¦®è²Œ'] }
            }
        ];

        // å–å¾—userç‰©ä»¶
        function getUserById(uid) {
            return usersDB.find(u => u.uid === uid);
        }

        // ç›¸ç´„ç³»çµ±ä¸»é¡
        class AppointmentSystem {
            constructor() {
                this.apiBaseUrl = 'https://your-api-domain.com/api';
                this.events = [];
                this.currentUserId = 1; // å‡è¨­ç™»å…¥è€…uid=1
                this.currentUser = getUserById(this.currentUserId);
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadEvents();
            }
            setupEventListeners() {
                document.getElementById('createBtn').addEventListener('click', () => this.showCreateModal());
                document.getElementById('closeCreate').addEventListener('click', () => this.hideCreateModal());
                document.getElementById('cancelCreate').addEventListener('click', () => this.hideCreateModal());
                document.getElementById('createForm').addEventListener('submit', (e) => this.handleCreateSubmit(e));
                document.getElementById('closeDetail').addEventListener('click', () => this.hideDetailModal());
                document.getElementById('filterBtn').addEventListener('click', () => this.filterEvents());
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadEvents());
                document.getElementById('adminBtn').addEventListener('click', () => this.handleAdminLogin());
                window.addEventListener('mousedown', (e) => {
                    // ä¿®æ­£ï¼šåªæœ‰é»æ“Šé»‘è‰²é®ç½©æ‰é—œé–‰modalï¼Œé¿å…èª¤é—œ
                    if (e.target.classList.contains('modal') && e.target.style.display === 'block') {
                        e.target.style.display = 'none';
                    }
                    if (e.target.classList.contains('user-review-modal') && e.target.style.display === 'block') {
                        this.hideUserReviewModal();
                    }
                });
                document.getElementById('closeUserReview').addEventListener('click', () => this.hideUserReviewModal());
            }

            async loadEvents() {
                this.showLoading();
                document.getElementById('categoryFilter').value = '';
                document.getElementById('timeFilter').value = '';
                const events = await this.getMockEvents();
                this.events = events;
                this.renderEvents(events);
            }
            // æ¨¡æ“¬æ´»å‹•è³‡æ–™
            async getMockEvents() {
                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve([
                            {
                                id: 1,
                                title: 'è¥¿é–€ç”ºç¾é£Ÿä¹‹æ—…',
                                category: 'ç¾é£Ÿ',
                                time: '2025-05-25T19:00',
                                startLocation: 'å°åŒ—è»Šç«™',
                                destination: 'è¥¿é–€ç”º',
                                description: 'ä¸€èµ·å»è¥¿é–€ç”ºåƒç¾é£Ÿï¼',
                                maxParticipants: 4,
                                maxMale: 2,
                                maxFemale: 2,
                                participants: [1, 2], // uid
                                creatorId: 2,
                                contact: 'Line: foodlover123',
                                createdAt: '2025-05-22T10:00:00'
                            },
                            {
                                id: 2,
                                title: 'ä¿¡ç¾©å€é›»å½±ç´„æœƒ',
                                category: 'å¨›æ¨‚',
                                time: '2025-05-26T15:00',
                                startLocation: 'å¸‚æ”¿åºœç«™',
                                destination: 'ä¿¡ç¾©å¨ç§€',
                                description: 'çœ‹æœ€æ–°ä¸Šæ˜ çš„é›»å½±',
                                maxParticipants: 6,
                                maxMale: 3,
                                maxFemale: 3,
                                participants: [1, 3, 4],
                                creatorId: 1,
                                contact: '0912-345-678',
                                createdAt: '2025-05-22T14:30:00'
                            }
                        ]);
                    }, 800);
                });
            }
            async createEvent(eventData) {
                // å¯¦éš›æ‡‰é€£API
                const result = { success: true, id: Date.now(), message: 'æ´»å‹•ç™¼èµ·æˆåŠŸ' };
                if (result.success) {
                    const newEvent = {
                        ...eventData,
                        id: result.id,
                        participants: [this.currentUserId],
                        creatorId: this.currentUserId,
                        createdAt: new Date().toISOString()
                    };
                    this.events.unshift(newEvent);
                }
                return result;
            }
            // åƒåŠ æ´»å‹•
            async joinEvent(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return this.showNotification('æ´»å‹•ä¸å­˜åœ¨', 'error');
                if (event.participants.includes(this.currentUserId)) return this.showNotification('æ‚¨å·²åƒèˆ‡', 'error');
                if (event.participants.length >= event.maxParticipants) return this.showNotification('æ´»å‹•å·²æ»¿', 'error');

                const user = getUserById(this.currentUserId);
                // è¨ˆç®—ç¾æœ‰ç”·å¥³
                let male = 0, female = 0;
                event.participants.forEach(uid => {
                    const u = getUserById(uid);
                    if (!u) return;
                    if (u.gender === 'male') male++;
                    else if (u.gender === 'female') female++;
                });
                if (user.gender === 'male' && male >= event.maxMale) return this.showNotification('ç”·ç”Ÿåé¡å·²æ»¿', 'error');
                if (user.gender === 'female' && female >= event.maxFemale) return this.showNotification('å¥³ç”Ÿåé¡å·²æ»¿', 'error');

                event.participants.push(this.currentUserId);
                this.showNotification('æˆåŠŸåŠ å…¥æ´»å‹•', 'success');
                this.renderEvents(this.events);
            }
            async leaveEvent(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return this.showNotification('æ´»å‹•ä¸å­˜åœ¨', 'error');
                if (event.creatorId === this.currentUserId) return this.showNotification('ç™¼èµ·äººç„¡æ³•å–æ¶ˆåƒèˆ‡ï¼Œè«‹å–æ¶ˆæ´»å‹•', 'error');
                const idx = event.participants.indexOf(this.currentUserId);
                if (idx === -1) return this.showNotification('æ‚¨æœªåƒèˆ‡', 'error');
                event.participants.splice(idx, 1);
                this.showNotification('å·²å–æ¶ˆåƒèˆ‡', 'success');
                this.renderEvents(this.events);
            }
            async cancelEvent(eventId) {
                const idx = this.events.findIndex(e => e.id === eventId);
                if (idx === -1) return this.showNotification('æ´»å‹•ä¸å­˜åœ¨', 'error');
                if (this.events[idx].creatorId !== this.currentUserId) return this.showNotification('åªæœ‰ç™¼èµ·äººå¯å–æ¶ˆ', 'error');
                if (!confirm('ç¢ºå®šè¦å–æ¶ˆï¼Ÿ')) return;
                this.events.splice(idx, 1);
                this.showNotification('æ´»å‹•å·²å–æ¶ˆ', 'success');
                this.renderEvents(this.events);
            }
            showLoading() {
                document.getElementById('eventsList').innerHTML = `
                    <div class="loading"><div class="spinner"></div></div>
                `;
            }
            // æ´»å‹•å¡ç‰‡æ¸²æŸ“
            renderEvents(events) {
                const eventsList = document.getElementById('eventsList');
                if (events.length === 0) {
                    eventsList.innerHTML = `
                        <div class="empty-state">
                            <h3>æš«ç„¡æ´»å‹•</h3>
                            <p>ç›®å‰æ²’æœ‰æ´»å‹•ï¼Œç™¼èµ·ä¸€å€‹æ–°æ´»å‹•å§ï¼</p>
                            <button class="btn btn-primary" onclick="app.showCreateModal()">ç™¼èµ·æ´»å‹•</button>
                        </div>`;
                    return;
                }
                eventsList.innerHTML = events.map(event => {
                    // ç”·å¥³ç¾æ³
                    let male = 0, female = 0;
                    let avatarsHtml = '';
                    event.participants.forEach(uid => {
                        const u = getUserById(uid);
                        if (!u) return;
                        if (u.gender === 'male') male++; else if (u.gender === 'female') female++;
                        avatarsHtml += `<div class="avatar${uid===event.creatorId?' creator':''}" title="${u.name}" onclick="event.stopPropagation(); app.showUserReview(${uid})">
                            <img src="${u.avatarUrl}" alt="${u.name}" />
                        </div>`;
                    });
                    const isFull = event.participants.length >= event.maxParticipants;
                    const isCreator = event.creatorId === this.currentUserId;
                    const isJoined = event.participants.includes(this.currentUserId);

                    let actionBtn = '';
                    if (isCreator) {
                        actionBtn = `<button class="btn btn-danger join-btn" onclick="event.stopPropagation(); app.cancelEvent(${event.id})">å–æ¶ˆæ´»å‹•</button>`;
                    } else if (isJoined) {
                        actionBtn = `<button class="btn btn-secondary join-btn" onclick="event.stopPropagation(); app.leaveEvent(${event.id})">å–æ¶ˆåƒèˆ‡</button>`;
                    } else if (isFull) {
                        actionBtn = `<span class="btn btn-secondary join-btn">å·²æ»¿</span>`;
                    } else {
                        // æ€§åˆ¥é‚è¼¯æç¤º
                        const user = getUserById(this.currentUserId);
                        let genderWarn = '';
                        if (user.gender === 'male' && male >= event.maxMale) genderWarn = 'ç”·ç”Ÿåé¡å·²æ»¿';
                        if (user.gender === 'female' && female >= event.maxFemale) genderWarn = 'å¥³ç”Ÿåé¡å·²æ»¿';
                        if (genderWarn) {
                            actionBtn = `<span class="btn btn-secondary join-btn">${genderWarn}</span>`;
                        } else {
                            actionBtn = `<button class="btn btn-primary join-btn" onclick="event.stopPropagation(); app.joinEvent(${event.id})">åŠ å…¥ +1</button>`;
                        }
                    }

                    return `
                    <div class="event-card" onclick="app.showEventDetail(${event.id})">
                        <div class="event-header">
                            <span class="event-category">${event.category}</span>
                            <span class="event-time">${this.formatDateTime(event.time)}</span>
                        </div>
                        <div class="event-details">
                            <div class="event-detail-item"><span class="event-detail-label">æ´»å‹•:</span>
                                <span class="event-detail-value">${event.title || event.destination}</span></div>
                            <div class="event-detail-item"><span class="event-detail-label">å‡ºç™¼:</span>
                                <span class="event-detail-value">${event.startLocation}</span></div>
                            <div class="event-detail-item"><span class="event-detail-label">ç›®çš„åœ°:</span>
                                <span class="event-detail-value">${event.destination}</span></div>
                            ${event.description ? `<div class="event-detail-item"><span class="event-detail-label">èªªæ˜:</span>
                                <span class="event-detail-value">${event.description}</span></div>` : ''}
                            <div class="event-detail-item">
                                <span class="event-detail-label">äººæ•¸:</span>
                                <span class="event-detail-value">${event.participants.length}/${event.maxParticipants}ï¼ˆç”·${male}/${event.maxMale} å¥³${female}/${event.maxFemale}ï¼‰</span>
                            </div>
                        </div>
                        <div class="event-footer">
                            <div class="avatar-list">${avatarsHtml}</div>
                            ${actionBtn}
                        </div>
                    </div>`;
                }).join('');
            }
            showCreateModal() {
    document.getElementById('createModal').classList.add('show');
}
hideCreateModal() {
    document.getElementById('createModal').classList.remove('show');
    document.getElementById('createForm').reset();
}
            async handleCreateSubmit(e) {
                e.preventDefault();
                // ç›´æ¥ç”¨ FormData å–å€¼ï¼Œé¿å… id cache å•é¡Œ
                const formData = new FormData(e.target);
                const eventData = {
                    title: formData.get('destination'),
                    category: formData.get('eventCategory'),
                    time: formData.get('eventTime'),
                    startLocation: formData.get('startLocation'),
                    destination: formData.get('destination'),
                    description: formData.get('description'),
                    maxParticipants: parseInt(formData.get('maxParticipants')),
                    contact: formData.get('contact'),
                    maxMale: parseInt(formData.get('maxMale')),
                    maxFemale: parseInt(formData.get('maxFemale'))
                };
                if (eventData.maxMale + eventData.maxFemale > eventData.maxParticipants) {
                    this.showNotification('ç”·å¥³ç¸½äººæ•¸ä¸å¯è¶…éç¸½äººæ•¸ä¸Šé™', 'error'); return;
                }
                if (eventData.maxMale + eventData.maxFemale < eventData.maxParticipants) {
                    this.showNotification('ç”·å¥³äººæ•¸ç¸½å’Œé ˆç­‰æ–¼ç¸½ä¸Šé™', 'error'); return;
                }
                const result = await this.createEvent(eventData);
                if (result.success) {
                    this.showNotification('æ´»å‹•ç™¼èµ·æˆåŠŸï¼', 'success');
                    this.hideCreateModal();
                    this.renderEvents(this.events);
                } else {
                    this.showNotification('ç™¼èµ·æ´»å‹•å¤±æ•—', 'error');
                }
            }
            showEventDetail(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;
                let male = 0, female = 0;
                let avatarsHtml = '';
                event.participants.forEach(uid => {
                    const u = getUserById(uid);
                    if (!u) return;
                    if (u.gender === 'male') male++; else if (u.gender === 'female') female++;
                    avatarsHtml += `<div class="avatar${uid===event.creatorId?' creator':''}" title="${u.name}" onclick="app.showUserReview(${uid});event.stopPropagation();">
                        <img src="${u.avatarUrl}" alt="${u.name}" />
                    </div>`;
                });
                const isFull = event.participants.length >= event.maxParticipants;
                const isCreator = event.creatorId === this.currentUserId;
                const isJoined = event.participants.includes(this.currentUserId);

                let actionBtn = '';
                if (isCreator) {
                    actionBtn = `<button class="btn btn-danger" onclick="app.cancelEvent(${event.id}); app.hideDetailModal();">å–æ¶ˆæ´»å‹•</button>`;
                } else if (isJoined) {
                    actionBtn = `<button class="btn btn-secondary" onclick="app.leaveEvent(${event.id}); app.hideDetailModal();">å–æ¶ˆåƒèˆ‡</button>`;
                } else if (isFull) {
                    actionBtn = `<span class="btn btn-secondary">æ´»å‹•å·²æ»¿</span>`;
                } else {
                    const user = getUserById(this.currentUserId);
                    let genderWarn = '';
                    if (user.gender === 'male' && male >= event.maxMale) genderWarn = 'ç”·ç”Ÿåé¡å·²æ»¿';
                    if (user.gender === 'female' && female >= event.maxFemale) genderWarn = 'å¥³ç”Ÿåé¡å·²æ»¿';
                    if (genderWarn) {
                        actionBtn = `<span class="btn btn-secondary">${genderWarn}</span>`;
                    } else {
                        actionBtn = `<button class="btn btn-primary" onclick="app.joinEvent(${event.id}); app.hideDetailModal();">åŠ å…¥æ´»å‹•</button>`;
                    }
                }
                document.getElementById('detailContent').innerHTML = `
                    <div style="padding: 1.5rem;">
                        <div class="event-detail-item"><span class="event-detail-label">æ´»å‹•æ™‚é–“:</span>
                            <span class="event-detail-value">${this.formatDateTime(event.time)}</span></div>
                        <div class="event-detail-item"><span class="event-detail-label">å‡ºç™¼åœ°é»:</span>
                            <span class="event-detail-value">${event.startLocation}</span></div>
                        <div class="event-detail-item"><span class="event-detail-label">ç›®çš„åœ°:</span>
                            <span class="event-detail-value">${event.destination}</span></div>
                        <div class="event-detail-item"><span class="event-detail-label">æ´»å‹•é¡åˆ¥:</span>
                            <span class="event-detail-value">${event.category}</span></div>
                        <div class="event-detail-item"><span class="event-detail-label">äººæ•¸:</span>
                            <span class="event-detail-value">${event.participants.length}/${event.maxParticipants}ï¼ˆç”·${male}/${event.maxMale} å¥³${female}/${event.maxFemale}ï¼‰</span></div>
                        ${event.description ? `<div class="event-detail-item"><span class="event-detail-label">å‚™è¨»èªªæ˜:</span>
                            <span class="event-detail-value">${event.description}</span></div>` : ''}
                        <div class="event-detail-item"><span class="event-detail-label">è¯çµ¡æ–¹å¼:</span>
                            <span class="event-detail-value">${event.contact}</span></div>
                        <div class="event-detail-item" style="margin-top:1.2rem;">
                            <span class="event-detail-label">åƒèˆ‡è€…:</span>
                            <span class="event-detail-value avatar-list">${avatarsHtml}</span>
                        </div>
                    </div>
                    <div class="form-actions">
                        ${actionBtn}
                        <button class="btn btn-secondary" onclick="app.hideDetailModal()">é—œé–‰</button>
                    </div>
                `;
                document.getElementById('detailModal').style.display = 'block';
            }
            hideDetailModal() {
                document.getElementById('detailModal').style.display = 'none';
            }
            filterEvents() {
                const categoryFilter = document.getElementById('categoryFilter').value;
                const timeFilter = document.getElementById('timeFilter').value;
                let filteredEvents = this.events;
                if (categoryFilter) filteredEvents = filteredEvents.filter(event => event.category === categoryFilter);
                if (timeFilter) {
                    const filterDate = new Date(timeFilter);
                    filteredEvents = filteredEvents.filter(event => new Date(event.time) >= filterDate);
                }
                this.renderEvents(filteredEvents);
            }
            formatDateTime(dateTimeString) {
                const date = new Date(dateTimeString);
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${month}/${day} ${hours}:${minutes}`;
            }
            showNotification(message, type = 'success') {
                const existingNotification = document.querySelector('.notification');
                if (existingNotification) existingNotification.remove();
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
            // æ–°å¢ï¼šé¡¯ç¤ºç”¨æˆ¶è©•åƒ¹å½ˆçª—
            showUserReview(uid) {
                const user = getUserById(uid);
                if (!user) return;
                const review = user.review || { good: 0, bad: 0, msgs: [] };
                let html = `
                    <div class="user-review-header">
                        <img src="${user.avatarUrl}" alt="${user.name}" />
                        <div class="user-review-name">${user.name} ${user.gender === 'male' ? 'â™‚ï¸' : 'â™€ï¸'}</div>
                        <div class="user-review-gb">ğŸ‘ ${review.good}ã€€ğŸ‘ ${review.bad}</div>
                    </div>
                    <div class="review-msg-list">
                        ${review.msgs.length === 0 ? '<div class="review-msg-item">æš«ç„¡æ–‡å­—è©•åƒ¹</div>' : review.msgs.map(msg => `<div class="review-msg-item">${msg}</div>`).join('')}
                    </div>
                `;
                document.getElementById('userReviewContent').innerHTML = `<span class="close-user-review" id="closeUserReview">&times;</span>${html}`;
                document.getElementById('userReviewModal').style.display = 'block';
                document.getElementById('closeUserReview').onclick = () => this.hideUserReviewModal();
            }
            hideUserReviewModal() {
                document.getElementById('userReviewModal').style.display = 'none';
            }
            // ç®¡ç†è€…åŠŸèƒ½
            handleAdminLogin() {
                if (adminUidTable.includes(this.currentUserId)) {
                    window.location.href = "admin.html";
                } else {
                    this.showNotification("æ‚¨ç„¡ç®¡ç†å“¡æ¬Šé™", "error");
                }
            }
        }
        const app = new AppointmentSystem();
        // è®“å…¨å±€å¯èª¿ç”¨
        window.app = app;
    </script>
</body>
</html>
